<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morse Code Trainer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the app's aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc; /* Light blue-grey background */
        }
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #e0e7ff;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-4xl bg-white p-6 md:p-10 rounded-xl card transition-all duration-300">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-6 text-center">Morse Code Trainer</h1>
        <p class="text-center text-gray-600 mb-8">Type English text to see the code, or type Morse code to decode instantly.</p>

        <!-- Translator Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- English Input -->
            <div class="flex flex-col">
                <label for="english-input" class="text-lg font-semibold text-gray-700 mb-2 flex items-center justify-between">
                    <span>English Text</span>
                    <button id="play-audio-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-1.5 px-4 rounded-lg transition-colors duration-200 text-sm shadow-md flex items-center" onclick="playMorseCode()" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2">
                            <path d="M12.9 6.262a.385.385 0 00-.234.026.495.495 0 00-.295.45V13.26c0 .248.16.471.4.471.1 0 .204-.037.295-.098l5.225-3.037a.5.5 0 000-.865L13.1 6.208a.386.386 0 00-.2-.016zM6 3.5a.5.5 0 01.5-.5h5a.5.5 0 010 1H6.5a.5.5 0 01-.5-.5zM5.5 6a.5.5 0 000 1h6a.5.5 0 000-1h-6zM5 8.5a.5.5 0 000 1h5a.5.5 0 000-1H5zM4.5 11a.5.5 0 000 1h4a.5.5 0 000-1h-4zM4 13.5a.5.5 0 000 1h3a.5.5 0 000-1H4z" clip-rule="evenodd" fill-rule="evenodd"></path>
                        </svg>
                        Play Audio
                    </button>
                </label>
                <textarea id="english-input" rows="8" class="p-3 border-2 border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition-all duration-200 resize-none text-gray-800 text-base" oninput="translateToMorse()"></textarea>
                <p id="english-length" class="text-sm text-gray-500 mt-2">0 characters</p>
            </div>

            <!-- Morse Output/Input -->
            <div class="flex flex-col">
                <label for="morse-output" class="text-lg font-semibold text-gray-700 mb-2">Morse Code</label>
                <textarea id="morse-output" rows="8" class="p-3 border-2 border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition-all duration-200 resize-none bg-indigo-50 text-indigo-800 font-mono text-base" oninput="translateToEnglish()"></textarea>
                <p id="morse-length" class="text-sm text-gray-500 mt-2">0 symbols</p>
            </div>
        </div>
        
        <!-- Status & Settings -->
        <div id="status-message" class="mt-8 text-center py-3 px-6 rounded-lg font-medium text-sm text-indigo-800 bg-indigo-100 hidden"></div>
        <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center text-sm text-gray-600">
            <div class="mb-4 sm:mb-0">
                <label for="wpm-speed" class="mr-2">Tone Speed (WPM):</label>
                <input type="number" id="wpm-speed" value="20" min="5" max="60" class="w-20 p-1 border rounded-md text-center">
            </div>
            <div>
                <span class="font-medium text-gray-700">Code Format:</span> Dot (.), Dash (-), Space (/)
            </div>
        </div>

    </div>

    <script>
        // --- Core Morse Code Mapping ---
        const MORSE_TO_ENGLISH = {
            '.-': 'A', '-...': 'B', '-.-.': 'C', '-..': 'D', '.': 'E', '..-.': 'F', '--.': 'G', '....': 'H',
            '..': 'I', '.---': 'J', '-.-': 'K', '.-..': 'L', '--': 'M', '-.': 'N', '---': 'O', '.--.': 'P',
            '--.-': 'Q', '.-.': 'R', '...': 'S', '-': 'T', '..-': 'U', '...-': 'V', '.--': 'W', '-..-': 'X',
            '-.--': 'Y', '--..': 'Z',
            '.----': '1', '..---': '2', '...--': '3', '....-': '4', '.....': '5',
            '-....': '6', '--...': '7', '---..': '8', '----.': '9', '-----': '0',
            '.-.-.-': '.', '--..--': ',', '..--..': '?', '-.-.--': '!',
            '-..-.': '/', '-.--.': '(', '-.--.-': ')', '.-...': '&', '---...': ':',
            '-.-.-.': ';', '-...-': '=', '.-.-.': '+', '-....-': '-', '..--.-': '_',
            '.-..-.': '"', '...-..-': '$', '.--.-.': '@',
            '/': ' ' // Word space
        };

        const ENGLISH_TO_MORSE = {};
        for (const [morse, char] of Object.entries(MORSE_TO_ENGLISH)) {
            ENGLISH_TO_MORSE[char] = morse;
        }

        // --- DOM Elements ---
        const englishInput = document.getElementById('english-input');
        const morseOutput = document.getElementById('morse-output');
        const englishLength = document.getElementById('english-length');
        const morseLength = document.getElementById('morse-length');
        const statusMessage = document.getElementById('status-message');
        const playAudioBtn = document.getElementById('play-audio-btn');
        const wpmSpeed = document.getElementById('wpm-speed');

        let isTranslatingFromEnglish = true; // Flag to manage bidirectional input lock

        // --- Translation Functions ---

        function translateToMorse() {
            if (!isTranslatingFromEnglish) return;
            const text = englishInput.value.toUpperCase();
            let morse = '';
            let validCharCount = 0;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (ENGLISH_TO_MORSE[char]) {
                    morse += ENGLISH_TO_MORSE[char] + ' ';
                    validCharCount++;
                } else if (char !== ' ' && char !== '\n') {
                    // Ignore unsupported characters but allow newlines/spaces
                }
            }

            morse = morse.trim();
            morseOutput.value = morse;
            englishLength.textContent = `${text.length} characters`;
            morseLength.textContent = `${morse.split(' ').length} symbols`;
            
            // Enable/disable play button
            playAudioBtn.disabled = morse.length === 0;

            // Brief lock to prevent re-translation in the other direction
            isTranslatingFromEnglish = false;
            setTimeout(() => isTranslatingFromEnglish = true, 50);
        }

        function translateToEnglish() {
            if (isTranslatingFromEnglish) return;
            const morseText = morseOutput.value.trim();
            const symbols = morseText.split(/\s+/); // Split by one or more spaces
            let english = '';
            let validSymbolCount = 0;

            for (let i = 0; i < symbols.length; i++) {
                const symbol = symbols[i];
                if (symbol === '') continue; // Skip multiple spaces

                if (MORSE_TO_ENGLISH[symbol]) {
                    english += MORSE_TO_ENGLISH[symbol];
                    validSymbolCount++;
                } else {
                    english += '#'; // Placeholder for unknown symbols
                    validSymbolCount++;
                }
            }

            englishInput.value = english;
            englishLength.textContent = `${english.length} characters`;
            morseLength.textContent = `${symbols.filter(s => s.length > 0).length} symbols`;

            // Brief lock to prevent re-translation in the other direction
            isTranslatingFromEnglish = true;
            setTimeout(() => isTranslatingFromEnglish = false, 50);
        }

        // Set up event listeners for simultaneous bidirectional translation
        englishInput.addEventListener('input', () => { isTranslatingFromEnglish = true; translateToMorse(); });
        morseOutput.addEventListener('input', () => { isTranslatingFromEnglish = false; translateToEnglish(); });

        // Initial update for length display
        englishLength.textContent = '0 characters';
        morseLength.textContent = '0 symbols';

        // --- Audio Generation ---
        let audioContext;
        let oscillator;
        let gainNode;
        let isPlaying = false;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                oscillator = audioContext.createOscillator();
                gainNode = audioContext.createGain();

                // Set frequency and connect nodes
                oscillator.type = 'sine'; // Sine wave is clean for tones
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime); // 600 Hz tone
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0, audioContext.currentTime); // Start silent

                // Start the oscillator, it will run continuously
                oscillator.start();
            }
        }

        function getTimings(wpm) {
            // Formula for Dot Duration (T) based on WPM (Paris standard is 50 WPM = 60ms dot)
            // T (seconds) = 1.2 / WPM
            const dotDuration = 1.2 / wpm; // T in seconds

            return {
                dot: dotDuration,            // 1T (dit)
                dash: dotDuration * 3,       // 3T (dah)
                elementPause: dotDuration,   // 1T (intra-char pause)
                charPause: dotDuration * 3,  // 3T (inter-char pause)
                wordPause: dotDuration * 7   // 7T (word pause)
            };
        }

        function playTone(duration, startTime) {
            gainNode.gain.setValueAtTime(0.5, startTime); // Turn on tone (0.5 volume)
            gainNode.gain.setValueAtTime(0, startTime + duration); // Turn off tone
            return startTime + duration; // Time when tone stops
        }

        async function playMorseCode() {
            if (isPlaying) {
                // Stop playback if already running
                stopMorseCode();
                return;
            }
            initAudioContext();
            
            const wpm = parseInt(wpmSpeed.value);
            const timings = getTimings(wpm);
            const morseText = morseOutput.value.trim();
            const symbols = morseText.split(' ');
            
            let currentTime = audioContext.currentTime;
            isPlaying = true;
            playAudioBtn.textContent = 'Stop Audio';
            statusMessage.textContent = 'Playing Morse Code...';
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800');
            statusMessage.classList.add('bg-indigo-100', 'text-indigo-800');

            try {
                for (let i = 0; i < symbols.length; i++) {
                    if (!isPlaying) break; // Check for stop before each new symbol

                    const symbol = symbols[i];
                    if (symbol === '/') {
                        // Word space
                        currentTime += timings.wordPause;
                    } else if (symbol.length > 0) {
                        // Character symbols (dots and dashes)
                        for (let j = 0; j < symbol.length; j++) {
                            const code = symbol[j];
                            const duration = code === '.' ? timings.dot : timings.dash;
                            
                            // Play the tone
                            currentTime = playTone(duration, currentTime);

                            // Intra-character space (pause between dots/dashes in a single letter)
                            if (j < symbol.length - 1) {
                                currentTime += timings.elementPause;
                            }
                        }
                        // Inter-character space (pause between letters)
                        if (i < symbols.length - 1 && symbols[i+1] !== '/') {
                            currentTime += timings.charPause;
                        }
                    }
                    // Wait until all scheduled tones are played
                    await new Promise(resolve => setTimeout(resolve, (currentTime - audioContext.currentTime) * 1000));
                }
            } catch (error) {
                console.error("Audio playback error:", error);
            } finally {
                if (isPlaying) {
                    stopMorseCode(false); // Finished playing, don't show stop message
                }
            }
        }

        function stopMorseCode(showStoppedMessage = true) {
            if (isPlaying) {
                // Quickly ramp down volume to prevent clicks
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                isPlaying = false;
                playAudioBtn.textContent = 'Play Audio';
                if (showStoppedMessage) {
                    statusMessage.textContent = 'Playback stopped by user.';
                    statusMessage.classList.remove('bg-indigo-100', 'text-indigo-800');
                    statusMessage.classList.add('bg-red-100', 'text-red-800');
                } else {
                    statusMessage.textContent = 'Playback finished.';
                    statusMessage.classList.remove('bg-red-100', 'text-red-800');
                    statusMessage.classList.add('bg-indigo-100', 'text-indigo-800');
                }
                setTimeout(() => statusMessage.classList.add('hidden'), 3000); // Hide status after 3s
            }
        }
        
        // Ensure play button is disabled initially
        playAudioBtn.disabled = true;

    </script>

</body>
</html>